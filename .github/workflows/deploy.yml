name: CD - Deploy to cloud server

on:
  # deploy process only starts if application has dockerized and pushed to container registry
  workflow_run:
    workflows: ["Dockerize - Build Test and Push"]
    # important: dockerize workflow must be running successfully
    types:
      - completed
  pull_request:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # URL of server which is able to make SSH connection
          host: ${{ secrets.SERVER_HOST }}
          # the user which contains deploy.sh bash script
          username: ${{ secrets.SERVER_USER }}
          # private key of server generated and server contains matching public key
          key: ${{ secrets.SERVER_SSH_KEY }}
          # Pass all required secrets to the deployment script
          envs: GHCR_TOKEN,DB_USER,DB_PASSWORD,DB_DATABASE
          script: |
            cd /opt/burgerman

            # Export secrets as environment variables for deploy.sh
            export GHCR_TOKEN="${GHCR_TOKEN}"
            export DB_USER="${DB_USER}"
            export DB_PASSWORD="${DB_PASSWORD}"
            export DB_DATABASE="${DB_DATABASE}"

            # Run deployment script
            ./deploy.sh
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
